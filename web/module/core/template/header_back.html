<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>{$title}</title>
<link rel="shortcut icon" type="image/x-icon" href="{$smarty.const.STATIC_URL}/images/favicon.ico">
<link href="{$smarty.const.STATIC_URL}/css/style.css" rel="stylesheet" type="text/css">
  {if $module == 'opponent_analysis'}
  <link rel="shortcut icon" href="{$smarty.const.SITE_URL}/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="{$smarty.const.SITE_URL}/css/infoviz.css" />
  {/if}
  {if $module == 't' || $module == "changweibo" || $module == 'user' || $module == 'analysis' || $module == 'log' || $module == 'app' || $module == 'opponent_analysis' || $module == 'timer'}
  <link rel="stylesheet" type="text/css" href="{$smarty.const.STATIC_URL}/css/emoticon.css" />
<script src="{$smarty.const.STATIC_URL}/js/jquery.min.js" type="text/javascript"></script>
  <script src="{$smarty.const.STATIC_URL}/js/jquery.mousewheel.js"></script>
  <script src="{$smarty.const.STATIC_URL}/js/jScrollPane.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/jquery-ui.min.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/jquery.ui.datepicker-zh-CN.js"></script>
  <link rel="stylesheet" href="{$smarty.const.STATIC_URL}/css/jquery-ui.css" type="text/css" />
  <script src="{$smarty.const.STATIC_URL}/js/emotions/jquery.emoticons.js" type="text/javascript"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/validate/jquery.validate.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/validate/messages_cn.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/validate/additional-methods.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/admin.js"></script>
  <script type="text/javascript" src="{$smarty.const.STATIC_URL}/js/mio_lib_min.js"></script>
  <script src="{$smarty.const.STATIC_URL}/js/weibo_length_min.js" type="text/javascript"></script>
  <link href="{$smarty.const.STATIC_URL}/css/jScrollPane.css" rel="stylesheet" type="text/css">

  <script type="text/javascript">
  var site_url = "{$smarty.const.SITE_URL}";
  var res_type = "{$res_type}";
  </script>
  {/if}
<!--[if IE 6]>
<link href="../css/ie6.css" rel="stylesheet" type="text/css">
<script src="../js/DD_belatedPNG_0.0.8a-min.js"></script>
<script>
  DD_belatedPNG.fix('.fixpng,.text-box,.text-box .box-title .left,.nav2-title a,.check,.check-on');
</script>
<![endif]-->
</head>

<body>
  <!--start:修改定时微博-->
  <div class="modify" id="add_weibo_edit_main" style="display:none">
    <div class="modify-title clearfix"><i class="modify-icon left"></i><h2 class="left">修改定时</h2><a href="javascript:;" id="edit_weibo_main_close" class="btn-close-warn right"></a></div>
    <div class="modify-con">
      <div class="add-weibo-title modify-weibo-title clearfix">
           <span class="word fixpng nobg left">修改定时微博(定时间隔至少10分钟)</span>
           <span class="word-count txtright right">
             <span class="beyond" id="edit_count_str">还可输入</span>
             <span class="num" id="edit_count_num">130</span>
             字
           </span>
       </div>
       <div class="add-weibo-area"><textarea class="add-weibo-text" id="add_weibo_edit_text"></textarea></div>
       <input type="hidden" id="edit_pic_val" />
       <input type="hidden" id="edit_weibo_appkey" />
       <div class="add-weibo-icon">
           <a href="javascript:void(0)" class="face" id="edit_face"></a>
           <a href="javascript:void(0)" class="pic" id="edit_add_pic"></a>
           <a href="javascript:void(0)" class="video" id="edit_video"></a>
           <a href="javascript:void(0)" class="music" id="edit_music"></a>
           <a href="javascript:void(0)" class="cloud" id="edit_cloud"></a>
       </div>
       <div class="add-weibo-time clearfix"><span class="title">发布时间</span>
           <input type="text" class="add-weibo-input" id="edite_add_input">&nbsp;&nbsp;
           <select id="add_weibo_hh">
       <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option>
</select>&nbsp;时&nbsp;&nbsp;
           <select id="add_weibo_mm">
       <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option><option>26</option><option>27</option><option>28</option><option>29</option><option>30</option><option>31</option><option>32</option><option>33</option><option>34</option><option>35</option><option>36</option><option>37</option><option>38</option><option>39</option><option>40</option><option>41</option><option>42</option><option>43</option><option>44</option><option>45</option><option>46</option><option>47</option><option>48</option><option>49</option><option>50</option><option>51</option><option>52</option><option>53</option><option>54</option><option>55</option><option>56</option><option>57</option><option>58</option><option>59</option>
</select>&nbsp;分
       </div>
       <div class="add-weibo-time clearfix"><span class="title">微博来源</span>
          <ul class="add-weibo-list w460" id="edit_applist">
          </ul>
          <div id="edit_weibo_auth_info" style="display:none;color:#f00"></div>
       </div>
       <div class="add-weibo-btn"><a href="javascript:void(0)" class="add-weibo-smt1" id="edit_btn_1"><span>定时发送</span></a><a href="javascript:void(0)" class="add-weibo-smt2" id="edit_btn_2"><span>立即发送</span> </a></div>
    </div>
  </div>
  <!--end:修改定时微博-->
<!-- 授权框 -->
<div id="authbox" style="position: absolute; top:10px;z-index: 20000;width: 100%;height: 400px;overflow: hidden;display:none;">
<iframe src="" id="authFloat" scrolling="no" style="position: absolute; left: 75px; height: 460px; width: 600px; border: 0; z-index: 20000;"></iframe>
</div>
<div id="authbox_bg" style="position:absolute;top:0px;width:100%;height:2000px;background:#000;filter:alpha(opacity=50);opacity:0.5;display:none;z-index:11998;">&nbsp;</div>
<!-- 授权框 end-->
   <!--start:应用过期提醒-->
  <div class="float-box fixpng warn-box" id="add_weibo_notice_main" style="display:none">
      <div class="float-con warn">
          <div class="warn-title clearfix"><span class="left">应用过期提醒</span><a href="javascript:void(0)" class="btn-close-warn right" id="add_weibo_notice_close"></a></div>
          <p>您的部分微博应用授权即将到期，过期后将不能进行定时任务、客户推荐等功能，请重新授权！</p>
          <p class="green">请务必重新授权以下应用：</p>
          <ul class="apply-list clearfix" id="add_weibo_notice">
          </ul>
          <p class="txtright"><a href="javascript:void(0)" id="add_weibo_notice_sure" class="btn-apply-sure"><span>确定</span></a></p>
      </div>
  </div>
  <!--end:应用过期提醒-->
<!--start:header-->
<div class="header-bg ">
  <div class="header clearfix">
    <div class="logo fixpng left"></div>
    <div class="user right">
      <a href="{AnUrl('user/admin/admin_logout')}" class="icon-exit fixpng right"></a>
    {if user_helper::is_super_admin()}
    <div class="icon-set fixpng right">
        <ul class="set-list" style="display:none">
          <li><a href="{AnUrl('app/admin/add')}">添加应用</a></li>
          <li><a href="{AnUrl('user/admin/member')}">管理员设置</a></li>
        </ul>
      </div>
    {/if}
      {if $is_admin == 1}<a href="javascript:void(0)" onclick="add_weibo_toggle();" id="tempBtn" class="icon-float fixpng right"></a>{/if}
      <a href="{AnUrl('app/admin')}" class="user-name right">{user_helper::display_name({user_helper::get_user_id()})}</a>
      <span class="user-photo right"><img src="{_uri('user',{user_helper::get_user_id()},'avatar')}" width="37" height="37"></span>
    </div>
  </div>
</div>
<!--end:header-->
{if $is_admin == 1}
 <!--start:待发微博-->
  <div class="committed"><span class="committed-btn committed-controll fixpng"><span>待发微博</span></span>
     <div id="committed-con">
        <div class="committed-title clearfix"><span class="left" id="add_weibo_num">待发微博</span><span class="right committed-controll" id="hide_save_ss" style="cursor:pointer">收起</span></div>
        <div class="committed-con">
           <div class="committed-tab">
              <span class="committed-tab-controll" onclick="weibo_flushCommitted('today')" style="color:#2589CF;" id="add_weibo_today_num">今天</span>
              <span class="committed-tab-controll" onclick="weibo_flushCommitted('tomorrow')" id="add_weibo_tom_num">明天</span>
              <span class="committed-tab-controll" id="add_weibo_all_num" onclick="weibo_flushCommitted('all')">更多</span>
           </div>
           <!--start:今天-->
           <div id="timeLineList" class="timeLineContainer">
            {$add_weibo_html}
           </div>
           <!--end:今天-->
        </div>
     </div>
  </div>
<!--end:待发微博-->
{/if}

<div id="wrap">
<div class="container">
  <div class="h80"></div>
  <!--start:创建一个定时微博-->
<div id="addWeibo">
  <div class="add-weibo clearfix">
     {if $is_admin == 1}<a class="add-weibo-close" onclick="add_weibo_hide();"></a>{/if}
     <div class="add-weibo-left left">
         <div class="add-weibo-title clearfix">
            <span class="word fixpng left"></span>
            <span class="word-count right" id="add_weibo_color">
            <span class="beyond" id="add_weibo_count_text">还可输入</span>
            <span id="add_weibo_title_count" class="num">140</span>字</span>
          </div>
         <div class="add-weibo-area"><textarea class="add-weibo-text" id="add_weibo_text" ></textarea></div>
         <input type="hidden" id="images_url" />
         <p class="add-weibo-icon">
          <a href="javascript:void(0)" id="add_face_icon" class="face"></a>
          <a href="javascript:void(0)" class="pic" id="add_weibo_upfile"></a>
          <a href="javascript:void(0)" class="video"></a>
          <a href="javascript:void(0)" class="music"></a>
          <a href="javascript:void(0)" class="cloud" id="cloud"></a>
        </p>
         <div class="add-weibo-btn">
          <a href="javascript:void(0)" class="add-weibo-smt1" id="add_weibo_smt1"><span>定时发送</span></a>
          <a href="javascript:void(0)" class="add-weibo-smt2" id="add_weibo_smt2">
            <span>立即发送</span> </a>
        </div>
        <!--start:发布成功提示-->
        <div id="add_weibo_suc" class="send-ok hidden">
          <p class="ok">发布成功！</p>
        </div>
        <!--end:发布成功提示-->
     </div>
     <div class="add-weibo-right right">
        <div class="add-weibo-set">发布设置</div>
        <div class="add-weibo-time padding15 clearfix"><span class="title">发布时间</span>
            <input id="add_weibo_time" type="text" class="add-weibo-input" value="{$smarty.now|date_format:"%Y-%m-%d"}">&nbsp;
            <input type="hidden" id="add_weibo_appkey" type="text" value="{config::get('sinaweibo_akey')}" />
            {widget file='make_option.html' model='timer' assign='make_option' func='make_option' }

        </div>
        <div class="add-weibo-time clearfix"><span class="title">微博来源</span>
            <ul class="add-weibo-list">
              {widget file='app_list.html' model='timer' assign='app_list' func='app_list' }
            </ul>
        </div>
        <span id="add_weibo_etime_info" style="display:none;color:#f00">您的授权在这个时段已过期或不存在</span>
     </div>
  </div>
</div>
<!--start:弹框-->
         <div id="add_weibo_face_close" class="text-box face-box">
             <div class="box-title clearfix"><span class="left">请选择表情</span><span class="close right"></span></div>
             <div class="box-con face-con">
                 <p id="box_con_face_con"></p>
             </div>
         </div>
         <div class="text-box pic-box" style="width:240px">
            <div class="pic-arrow"></div>
             <iframe id="openWinDivF" frameborder="0" height="142" width="240" allowtransparency="true" scrolling="no" src="{$smarty.const.STATIC_URL}/timer/addpic"></iframe>
         </div>
         <div class="text-box video-box">
             <div class="box-title clearfix"><span class="left">请选择视频来源</span><span class="close right"></span></div>
             <div class="box-con">
                 <p class="black">输入视频网站播放页链接地址</p>
                 <p>目前已支持<a href="http://video.sina.com.cn/" target="_blank">新浪博客</a>、<a href="http://www.youku.com" target="_blank">优酷网</a>、<a href="http://www.tudou.com" target="_blank">土豆网</a>等网站</p>
                 <p class="clearfix"><input type="text" id="video_box_smt_input" class="video-box-ipt left"><input type="submit" value="确定" class="video-box-smt right" id="video_box_smt_btn" /></p>
             </div>
         </div>
         <div class="text-box music-box">
             <div class="box-title clearfix"><span class="left">请选择歌曲链接</span><span class="close right"></span></div>
             <div class="box-con">
                 <p>请输入MP3链接或新浪乐库单曲播放页链接</p>
                 <p class="clearfix"><input type="text" id="music_box_smt_input" class="video-box-ipt left"><input type="submit" value="确定" class="video-box-smt right" id="music_box_smt_btn" /></p>
             </div>
         </div>
         <!--end:弹框-->
<div class="show_e"></div>
<!--end:创建一个定时微博-->
{if $is_admin == 0}
<!--待发微博-->
<div class="user-committed"><span class="committed-btn user-committed-btn committed-controll fixpng"><span>待发微博</span></span>
  <div id="user-weibo" style="display:none">
      <div class="committed-title clearfix"><span class="left" id="add_weibo_num">待发微博</span>
        <!--<span class="right committed-controll" style="cursor:pointer">收起</span>-->
      </div>
      <div class="committed-con">
         <div class="committed-tab">
            <span class="committed-tab-controll" onclick="weibo_flushCommitted('today')" style="color:#2589CF;" id="add_weibo_today_num">今天</span>
            <span class="committed-tab-controll" onclick="weibo_flushCommitted('tomorrow')" id="add_weibo_tom_num">明天</span>
            <span class="committed-tab-controll" onclick="weibo_flushCommitted('all')" id="add_weibo_all_num">全部</span>
         </div>
         <!--start:今天-->
         <div id="timeLineList" class="timeLineContainer user-timeLineContainer" >
          {$add_weibo_html}
         </div>
      </div>
  </div>
</div>

{/if}
<!--end:待发微博-->
<script>
  $(function(){
    //头部设置部分下拉菜单
       $('.icon-set').mouseenter(function(){
      $(this).addClass('icon-set-on');
       $('.set-list').fadeIn(200);
    });
    $('.icon-set').mouseleave(function(e){
       $(this).removeClass('icon-set-on');
       $('.set-list').fadeOut(200);
    });
  })
</script>
<!-- 转发微博 JS start -->
<script>
var committedBtn = 0;
var addWeiboToggle = 0;
var add_weibo_init = 1;
var last_select_name = '';

var mio = {
  is_admin: "{$is_admin}",
  mainName: '',
  call_pic_target: 'images_url',
  call_target_main: 'add_weibo_text',
  call_ak: 'add_weibo_appkey',
  call_send_time: 'add_weibo_time',
  call_h: 'add_weibo_h',
  call_m: 'add_weibo_m',
  call_str: 'add_weibo_count_text',
  call_num: 'add_weibo_title_count',
  call_btn1: 'add_weibo_smt1',
  call_btn2: 'add_weibo_smt2',
  call_type: 'a',
  call_auth: 'add_weibo_etime_info',
  edit_id: 0,
  init: function() {
    if (this.is_admin == 1) {
      this.mainName = 'committed-con';
    } else {
      this.mainName = 'user-weibo';
    }
    mio.e_init();
  },
  edit: function(t) {
    var i = t.attr('cid');
    this.edit_id = i;
    this.init_editer(i);

  },
  init_editer: function(i) {
    $.post('{$smarty.const.SITE_URL}/timer/ajax/get_weibo_info&rand='+parseInt(Math.random()*100), { i:i }, function(d){
      if ( d.err == '0' )
      {
        $('#add_weibo_edit_text').val(d.info.weibo_info.content);
        $('#edite_add_input').val(d.info.y);
        $('#add_weibo_hh').val(d.info.h);
        $('#add_weibo_mm').val(d.info.i);
        $('#edit_weibo_appkey').val(d.info.appkey);
        $('#edit_applist').empty().html(d.list);
        if ( d.info.weibo_info.cover == '' || d.info.weibo_info.cover == undefined )
        {
          $('#edite_weibo_pic_added').hide();
        }
        else
        {
          $('#edite_weibo_added_url').empty().html(d.info.weibo_info.cover);
          $('#edit_pic_val').val(d.info.weibo_info.cover);
          $('#edite_weibo_pic_added').show();
        }
      }
      else
      {
        alert(d.info);
        return false;
      }
      $('#add_weibo_edit_main').attr( { style:'top:'+(miolib.scroll_height()*1+100)+'px' } );
      $('#add_weibo_edit_main').show();
    }, 'json');
    mio.e_init();
  },
  e_init: function(){
    mio.flush_length();
    $('#add_weibo_edit_text').bind('keyup', function(){
      mio.flush_length();
    });
    $('#add_weibo_edit_text').bind('blur', function(){
      mio.flush_length();
    });
    $('#edit_weibo_pic_added_c').bind('click', function(e){
      mio.edite_pic_hide();
      e.stopPropagation();
    });
    $('#edit_add_pic, #edit_video, #edit_music').bind('click', function(){
      mio.edit_mode();
    });
    $('#add_weibo_upfile').bind('click', function(){
      mio.add_mode();
    });
    $('#edit_weibo_main_close').bind('click', function(){
      mio.edite_main_close();
    });
    $('#add_weibo_smt1').bind('click', function(e){
      mio.add_mode();
      add_weibo('1');
      e.stopPropagation();
    });
    $('#add_weibo_smt2').bind('click', function(e){
      mio.add_mode();
      add_weibo('2');
      e.stopPropagation();
    });
    $('#edit_btn_1').bind('click', function(e){
      mio.edit_mode();
      add_weibo('1');
      e.stopPropagation();
    });
    $('#edit_btn_2').bind('click', function(e){
      mio.edit_mode();
      add_weibo('2');
      e.stopPropagation();
    });
  },
  edit_weibo_sub: function(i){
    if ( i == undefined || i == '' )
    {
      return false;
    }
    $.post('{$smarty.const.SITE_URL}/timer/ajax/editor_sub&rand='+parseInt(Math.random()*100), { i:i }, function(d){
      if (d.err == '0')
      {
        reflush_weibo_list();
        return false;
      }
      else
      {
        alert(d.info);
        return false;
      }
    }, 'json');
  },
  flush_length: function(){
    var str = $('#add_weibo_edit_text').val();
    add_weibo_count = add_weibo_getLength(str);
    var count = 140 - add_weibo_count;
    if( count >= 0 )
    {
      $('#edit_count_str').empty().html('还可输入');
      $('#edit_count_str').removeClass('colorff0000');
    }
    else
    {
      count = count*(-1);
      $('#edit_count_str').empty().html('已经超过');
      $('#edit_count_str').addClass('colorff0000');
    }
    $('#edit_count_num').empty().html(count);
  },
  edit_mode: function(){
    mio.call_pic_target = 'edit_pic_val';
    mio.call_target_main = 'add_weibo_edit_text';
    mio.call_ak = 'edit_weibo_appkey';
    mio.call_send_time = 'edite_add_input';
    mio.call_h = 'add_weibo_hh';
    mio.call_m = 'add_weibo_mm';
    mio.call_str = 'edit_count_str';
    mio.call_num = 'edit_count_count';
    mio.call_btn1 = 'edit_btn_1';
    mio.call_btn2 = 'edit_btn_2';
    mio.call_type = 'e';
    mio.call_auth = 'edit_weibo_auth_info';
  },
  add_mode: function(){
    mio.call_pic_target = 'images_url';
    mio.call_target_main = 'add_weibo_text';
    mio.call_ak = 'add_weibo_appkey';
    mio.call_send_time = 'add_weibo_time';
    mio.call_h = 'add_weibo_h';
    mio.call_m = 'add_weibo_m';
    mio.call_str = 'add_weibo_count_text';
    mio.call_num = 'add_weibo_title_count';
    mio.call_btn1 = 'add_weibo_smt1';
    mio.call_btn2 = 'add_weibo_smt2';
    mio.call_type = 'a';
    mio.call_auth = 'add_weibo_etime_info';
  },
  edite_pic_hide: function(){
    $('#edite_weibo_pic_added').hide();
  },
  edite_main_close: function(){
    $('#add_weibo_edit_main').hide();
    add_weibo_hidewin();
  },
  reflash: function(t, c) {
    t.children('.add_weibo_edit_ta').unbind();
    t.empty().html(c);
  }
};

mio.init();
$('#add_weibo_notice_close,#add_weibo_notice_sure').click(function(){
  $('#add_weibo_notice_main').hide();
})
$('#hide_save_ss').click(function(){
    $('{$smarty.const.SITE_URL}/timer/ajax/set_wait_sess', { } , function(a){
    }, 'json');
});

$('.committed-controll').click(function(){
  committed_show();
  return false;
})
$('.committed-tab-controll').click(function(){
  $('.committed-tab-controll').attr( { style:'color:#000000' } );
  $(this).removeClass('normal').attr( { style:'color:#2589CF' } );
  return false;
})
$('.time-line-trash').live('click', function(){
  var cid = $(this).attr('cid');
  var r = confirm('确定要这么做?');
  if ( r == false ) {
    return false;
  }
  $.get('{$smarty.const.SITE_URL}/timer/ajax/del_publish&rand=', { rand:parseInt(Math.random()*100), cid:cid }, function(data){
  } ,'json');
  $(this).parent().parent().hide();
  return false;
})
$('.time-line-edit').live('click', function(){
  mio.edit($(this));
})

function change_iframe_height(height)
{
  $('#openWinDivF').attr( { height: height } );
}

function add_weibo_toggle()
{
  if( addWeiboToggle == 1 )
  {
    add_weibo_hide();
    addWeiboToggle = 0;
  }
  else
  {
    add_weibo_show();
    addWeiboToggle = 1;
  }
  return false;
}
function committed_in()
{
  if (mio.is_admin == 1) {
    $('#'+mio.mainName).css( { 'left':'98%' } );
    $('.committed-btn').fadeOut(500);
    $('#'+mio.mainName).show();
    $('#pane1').jScrollPane( { scrollbarWidth:5 } );
    $('#'+mio.mainName).animate( { left:'50%',opacity:'100' }, 1000 );
  } else {
    $('#'+mio.mainName).css( { 'left':'0%' } );
    $('.committed-btn').fadeOut(500);
    $('#'+mio.mainName).show();
  }
}
function committed_out()
{
  if (mio.is_admin == 1) {
    $('#'+mio.mainName).css( { 'left':'50%' } );
    $('.committed-btn').fadeIn(500);
    $('#'+mio.mainName).animate( { left:'98%',opacity:'0' }, 1000 );
  } else {
    $('#'+mio.mainName).hide();
  }
}
function committed_show()
{
  if( committedBtn == 0 )
  {
    if( add_weibo_isshow == 1 )
    {
      committed_in();
      $('.committed-btn').css( { 'top':'330px' } );
      if (mio.is_admin == 1) {
        $('.committed').css( { 'position':'relative' } );
        $('#'+mio.mainName).css( { 'top':'330px' } );
      }
    }
    else
    {
      committed_in();
      $('.committed-btn').css( { 'top':'60px' } );
      if (mio.is_admin == 1) {
        $('.committed').css( { 'position':'fixed' } );
        $('#'+mio.mainName).css( { 'top':'60px' } );
      }
    }
    committedBtn = 1;
  }
  else
  {
    $.post('{$smarty.const.SITE_URL}/timer/ajax/set_wait_sess', { rand:parseInt(Math.random()*100) } , function(a){
    }, 'json');
    committed_out();
    $('.committed-btn').css( { 'top':'60px' } );
    if (mio.is_admin == 1) {
      $('.committed').css( { 'position':'fixed' } );
    }
    committedBtn = 0;
  }
}
function weibo_flushCommitted( type ){
  last_select_name = type;
  switch( type ){
    case 'today':
      var increment = 0;
      break;
    case 'tomorrow':
      var increment = -1;
      break;
    case 'all':
      var increment = 'all';
      break;
    default:
      var increment = 0;
  }
  $.get( '{$smarty.const.SITE_URL}/timer/ajax/get_queue_for_index', { rand:parseInt(Math.random()*100), increment:increment, is_admin:mio.is_admin }, function(data){
    if(data.err == '0'){
      $('#timeLineList').empty().html(data.html);
      $(".add_weibo_list_text_r").emotionsToHtml();
    } else {
      alert(data.err);
    }
  } ,'json');
}
</script>
<!-- 转发微博 JS end -->
<!-- 定时微博 JS START -->
<script type="text/javascript" src="{$smarty.const.SITE_URL}/js/at.js"></script>
<script type="text/javascript" src="{$smarty.const.SITE_URL}/js/ajaxpage.js"></script>
<script>

  var siteUrl = '{$smarty.const.SITE_URL}';
  var add_weibo_lock = 0;
  var add_weibo_count = 0;
  var add_weibo_timer = '';
  var add_weibo_timer_flag = 0;
  var add_weibo_isshow = 0;

  mblog.Func.bindAtToTextarea(document.getElementById("add_weibo_text"));
  mblog.Func.bindAtToTextarea(document.getElementById("add_weibo_edit_text"));

  $('#add_weibo_text').keyup(function(){
    add_weibo_flush_count();
    return false;
  })
  $('#add_weibo_text').blur(function(){
    if( add_weibo_count >= 140 )
    {
      do_alert_color();
    }
  })
  $('#cloud').click(function(){
    var txt = $('#add_weibo_text').val();
    txt = '#请输入话题的名称#'+txt;
    $('#add_weibo_text').val(txt);
    add_weibo_flush_count();
    miolib.str_select('add_weibo_text', 1, 9);
    $('#add_weibo_text').focus();
    return false;
  })
  $('#edit_cloud').click(function(){
    var txt = $('#add_weibo_edit_text').val();
    txt = '#请输入话题的名称#'+txt;
    $('#add_weibo_edit_text').val(txt);
    add_weibo_flush_count();
    miolib.str_select('add_weibo_edit_text', 1, 9);
    $('#add_weibo_edit_text').focus();
    return false;
  })
  $('.add_weibo_radio').click(function(){
    mio.add_mode();
    var id = $(this).attr('value');
    $('#'+mio.call_ak ).val(id);
    add_weibo_check_etime();
    $('.add_weibo_radio').removeAttr('checked');
    $(this).attr( { checked:true } );
  })
  $('.edit_weibo_radio').live('click', function(){
    mio.edit_mode();
    var id = $(this).attr('value');
    $('#'+mio.call_ak).val(id);
    add_weibo_check_etime();
    $('.edit_weibo_radio').removeAttr('checked');
    $(this).attr( { checked:true } );
  })
  $('#video_box_smt_btn').click(function(){
    var txt = $('#video_box_smt_input').val();
    if( txt == '' )
    {
      return false;
    }
    $.post('{$smarty.const.SITE_URL}/timer/ajax/mio_surl', { url:txt } , function(d){
      if( d.err == '0' ) {
        append_last( d.info );
        $('.text-box').hide();
      } else {
        alert(d.info);
      }
    }, 'json');

    return false;
  })
  $('#music_box_smt_btn').click(function(){
    var txt = $('#music_box_smt_input').val();
    if( txt == '' )
    {
      return false;
    }
    $.post('{$smarty.const.SITE_URL}/timer/ajax/mio_surl', { url:txt } , function(d){
      if( d.err == '0' ) {
        append_last( d.info );
        $('.text-box').hide();
      } else {
        alert(d.info);
      }
    }, 'json');
    return false;
  })
  $('#add_weibo_time, #add_weibo_h, #add_weibo_m').change(function(){
    add_weibo_check_etime();
    return false;
  })
  $('#edite_add_input, #add_weibo_hh, add_weibo_mm').change(function(){
    mio.edit_mode();
    add_weibo_check_etime();
    return false;
  })
  setInterval(function(){
    add_weibo_set_time();
  } , 600000 );
  function add_weibo_set_time( )
  {
    var send_h     = $('#add_weibo_h').val();
    var send_m     = $('#add_weibo_m').val();
    var send_time  = $('#add_weibo_time').val();
    var arr = send_time.split('-');
    var mou = arr[1] - 1;
    var ux = Date.UTC(arr[0], mou, arr[2], send_h, send_m );
    ux = ux - 8*3600000;
    ux = ux*1 + 600000;
    var str = miolib.date(ux/1000);
    var arrday = str.split(' ');
    var strtime = arrday[1].split(':');
    $('#add_weibo_h').val(strtime[0]);
    $('#add_weibo_m').val(strtime[1]);
    $('#add_weibo_time').val(arrday[0]);
    return true;
  }

  function add_weibo_check_etime(ak)
  {
    var send_h     = $('#'+mio.call_h).val();
    var send_m     = $('#'+mio.call_m).val();
    var send_time  = $('#'+mio.call_send_time).val();
    var appkey       = $('#'+mio.call_ak).val();
    if ( ak !== undefined && ak !== '' )
    {
      appkey = ak;
    }
    if( send_h == '' || send_m == '' || send_time == '' || appkey == '' )
    {
      return;
    }
    $.post('{$smarty.const.SITE_URL}/timer/ajax/check_etime?rand='+parseInt(Math.random()*100), { send_h:send_h, send_m:send_m, send_time:send_time, appkey:appkey }, function(data){
      if( data.err == '1' )
      {
        $('#'+mio.call_auth).empty().html('您的授权在这个时段已过期或不存在<a class="user_auth" href="'+data.href+'" authtype="sina" alt="'+appkey+'" target="_blank">点此续权</a>').show();
      }
      else if( data.err == '3' )
      {
        $('#'+mio.call_auth).empty().html('您的QQ授权在这个时段已过期或不存在<a class="user_auth" href="'+data.qqhref+'" authtype="qq" alt="'+data.appkey+'" target="_blank">点此续权</a>').show();
      }
      else
      {
        $('#'+mio.call_auth).hide();
      }
      mio.add_mode();
    } ,'json');
  }

  function reflush_weibo_list()
  {
    $.post('{$smarty.const.SITE_URL}/timer/ajax/init?rand='+parseInt(Math.random()*100), { } , function(d){
      if(d.err == '0') {
        $('#add_weibo_num').empty().html('待发微博('+d.count+')');
        $('#add_weibo_today_num').empty().html('今天('+d.today+')');
        $('#add_weibo_tom_num').empty().html('明天('+d.tom+')');
        $('#add_weibo_all_num').empty().html('全部('+d.count+')');
        weibo_flushCommitted(last_select_name);
      }
    }, 'json');
  }

  function add_weibo_clear_area()
  {
    $('#add_weibo_text').val('');
    $('#add_weibo_text').empty();
    $('#video_box_smt_input').val('');
    $('#music_box_smt_input').val('');
    add_weibo_deliamges();
    add_weibo_flush_count();
    $('#add_weibo_text').focus();
    $('.text-box').hide();
  }

  function add_weibo_hidewin()
  {
    $('.text-box').hide();
    return false;
  }
  function add_weibo_deliamges()
  {
    $('.text-box').hide();
    $('#openWinDivF').attr( { src:'{$smarty.const.STATIC_URL}/timer/addpic' } );
    $('#'+mio.call_pic_target).val('');
    $('#openWinDivF').attr( { height: 142 } );
    return false;
  }
  function append_last( info )
  {
    var txt = $('#'+mio.call_target_main).val();
    txt = txt+info+' ';
    $('#'+mio.call_target_main).val(txt);
    miolib.str_toend(mio.call_target_main);
    mio.add_mode();
    return false;
  }
  function update_ImgInfo( url )
  {
    $('#'+mio.call_pic_target).val(url);
    return false;
  }
  function add_weibo_flush_count()
  {
    var str = $('#'+mio.call_target_main).val();
    add_weibo_count = add_weibo_getLength(str);
    var count = 140 - add_weibo_count;
    if( count >= 0 )
    {
      $('#'+mio.call_str).empty().html('还可输入');
      $('#'+mio.call_count).removeClass('colorff0000');
    }
    else
    {
      count = count*(-1);
      $('#'+mio.call_str).empty().html('已经超过');
      $('#'+mio.call_count).addClass('colorff0000');
    }
    $('#'+mio.call_num).empty().html(count);
  }
  function do_alert_color()
  {
    alert_color();
    setTimeout(function(){
      clearInterval(add_weibo_timer);
      $('#add_weibo_text').attr( { style:'background-color:#ecf8ff' } );
    }, 2000);
  }

  function alert_color()
  {
    add_weibo_timer = setInterval(function(){
      if(add_weibo_timer_flag == 0)
      {
        $('#add_weibo_text').attr( { style:'background-color:#ecf8ff' } );
        add_weibo_timer_flag = 1;
      }
      else
      {
        $('#add_weibo_text').attr( { style:'background-color:#fca4e2' } );
        add_weibo_timer_flag = 0;
      }
    }, 300);
  }
  function add_weibo_confirm( type, username )
  {
    var r = confirm('用户'+username+'不存在,是否继续发送?');
    if( r == true )
    {
      add_weibo_lock = 0;
      eval("add_weibo( type, '1')");
    }
    else
    {
      return false;
    }
  }

  function add_weibo_suc()
  {
    reflush_weibo_list();
    add_weibo_clear_area();
    $('#add_weibo_suc').fadeIn(200);
    setTimeout(function(){
      $('#add_weibo_suc').fadeOut(200);
    }, 1000)
  }

  function add_weibo( type, force )
  {
    if( add_weibo_lock == 1 )
    {
      return false;
    }
    add_weibo_lock = 1;
    var content    = $('#'+mio.call_target_main).val();
    var send_h     = $('#'+mio.call_h).val();
    var send_m     = $('#'+mio.call_m).val();
    var send_time  = $('#'+mio.call_send_time).val();
    var akey       = $('#'+mio.call_ak).val();
    var images     = $('#'+mio.call_pic_target).val();
    add_weibo_flush_count();
    if( force == undefined )
    {
      force = 0;
    }
    else
    {
      force = 1;
    }
    if( type == '1')
    {
      if( content == '' || send_h == '' || send_m == '' || send_time == '' || akey == '' )
      {
        alert('请把信息填写完整');
        add_weibo_lock = 0;
        return false;
      }
    }
    else
    {
      if( content == '' || akey == '' )
      {
        alert('请把信息填写完整');
        add_weibo_lock = 0;
        return false;
      }
    }
    if( add_weibo_count > 140 )
    {
      alert('发布字数超过140字!');
      add_weibo_lock = 0;
      return false;
    }
    if( type == '1' )
    {
      if( mio.call_type == 'e' )
      {
        var eid = mio.edit_id;
        if ( mio.edit_id == 0 || mio.edit_id == '' )
        {
          alert('编辑id不存在!');
          return false;
        }
      }
      $('#'+mio.call_btn1).children('span').empty().html('发送中...');
      $.post('{$smarty.const.SITE_URL}/timer/ajax/create_queue?rand='+parseInt(Math.random()*100), { content:content, send_h:send_h, send_m:send_m, send_time:send_time, type:'S', appkey:akey, images:images, force:force, mio:mio.call_type, eid:mio.edit_id }, function(data){

        if(data.err == 0)
        {
          console.log(mio.call_type);
          if( mio.call_type == 'a' )
          {
            add_weibo_suc();
            add_weibo_set_time();
          }
          else
          {
            reflush_weibo_list();
            mio.edite_main_close();
          }
        }
        else if( data.err == 1)
        {
          add_weibo_confirm( type, data.username );
        }
        else
        {
          alert(data.info);
        }
        $('#'+mio.call_btn1).children('span').empty().html('定时发送');
        add_weibo_lock = 0;
        mio.add_mode();
      } , 'json');
    }
    else
    {
      if( mio.call_type == 'e' )
      {
        var eid = mio.edit_id;
        if ( mio.edit_id == 0 || mio.edit_id == '' )
        {
          alert('编辑id不存在!');
          return false;
        }
      }
      $('#'+mio.call_btn2).children('span').empty().html('发送中...');
      $.post('{$smarty.const.SITE_URL}/timer/ajax/publish_now?rand='+parseInt(Math.random()*100), { content:content, appkey:akey, images:images, force:force, mio:mio.call_type, eid:mio.edit_id } , function(data){
        if(data.err == 0){
          if ( mio.call_type == 'a' )
          {
            add_weibo_suc();
            add_weibo_set_time();
          }
          else
          {
            reflush_weibo_list();
            mio.edite_main_close();
          }
        } else if(data.err == 1) {
          add_weibo_confirm( type, data.username );
        } else {
          alert(data.info);
        }
        $('#'+mio.call_btn2).children('span').empty().html('立即发送');
        add_weibo_lock = 0;
        mio.add_mode();
      } , 'json');
    }
    return false;
  }

  function add_weibo_show()
  {
    if (mio.is_admin == 1) {
      $('#addWeibo').fadeIn(1000);
    } else {
      $('#addWeibo').show();
    }
    $('.committed').css( { 'position':'relative' } );
    $('.committed-btn').css( { 'top':'330px' } );
    if (mio.is_admin == 1) {
      $('#'+mio.mainName).css( { 'top':'330px' } );
    }
    committed_in();
    add_weibo_isshow = 1;
    committedBtn = 1;
    if (add_weibo_init == 0) {
      $.post('{$smarty.const.SITE_URL}/timer/ajax/set_sess?rand='+parseInt(Math.random()*100), { val:1 } , function(){
      }, 'json');
    }
    return false;
  }
  function add_weibo_hide()
  {
    if (mio.is_admin == 1) {
      $('#addWeibo').fadeOut(1000);
    } else {
      $('#addWeibo').hide();
    }
    $('.committed').css( { 'position':'fixed' } );
    $('.committed-btn').css( { 'top':'60px' } );
    committed_out();
    add_weibo_isshow = 0;
    committedBtn = 0;
    $.post('{$smarty.const.SITE_URL}/timer/ajax/set_sess?rand='+parseInt(Math.random()*100), {  } , function(){
    }, 'json');
    return false;
  }

  function add_weibo_list_hide_fast()
  {
    $('#'+mio.mainName).hide();
    $('.committed-btn').fadeIn(500);
    committedBtn = 0;
  }

  $(function(){
    $( "#add_weibo_time, #edite_add_input" ).datepicker({
      monthNames:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
      maxDate: "+0M +7D",
      minDate: "+0M +0D",
      dateFormat: 'yy-mm-dd',
      inline: true,
      bgiframe: true,
      showAnim: '',
      duration: '',
      showOtherMonths: true,
      selectOtherMonths: true
    });
    $('.user_auth').live('click', function(){
      var appkey = $(this).attr('alt');
      if ( appkey == '' )
      {
        return false;
      }
      $('#add_weibo_etime_info, #add_weibo_notice_main, #edit_weibo_auth_info').hide();
      return true;
    });
    // 显示授权层
    function showAuthFloat()
    {
        $('#authbox, #authbox_bg').show();
    }

    //隐藏授权框
    function hideAuthFloat()
    {
      $('#authbox, #authbox_bg').hide();
    }

    $('.add-weibo-icon a.face').click(function(){
     $('.text-box').hide();
     var p=$(this).offset();
     var t=p.top + 22;
     var l=p.left - 10;
      $('.face-box').css( { 'display':'block','left':l,'top':t } )
   });
   $('.add-weibo-icon a.pic').click(function(){
    $('.text-box').hide();
     var p=$(this).offset();
     var t=p.top + 22;
     var l=p.left - 26;
      $('.pic-box').css( { 'display':'block','left':l,'top':t } )
   });
   $('.add-weibo-icon a.video').click(function(){
    $('.text-box').hide();
     var p=$(this).offset();
     var t=p.top + 22;
     var l=p.left - 53;
      $('.video-box').css( { 'display':'block','left':l,'top':t } )
   });
   $('.add-weibo-icon a.music').click(function(){
    $('.text-box').hide();
     var p=$(this).offset();
     var t=p.top + 22;
     var l=p.left - 78;
      $('.music-box').css( { 'display':'block','left':l,'top':t } )
   });
   $('.text-box .close').click(function(){
      $(this).closest('.text-box').hide();
   })
  });
  $('.edit_sub').live('click', function(){
    var r = confirm('立即发送此微博?');
    if( r == false )
    {
      return false;
    }
    mio.edit_weibo_sub($(this).attr('cid'));
  });

  $(function(){
    if ( add_weibo_auth_info !== '' ) {
      $('#add_weibo_notice').empty().html(add_weibo_auth_info).show();
    }
    {if $is_admin == 1}
    $.post('{$smarty.const.SITE_URL}/timer/ajax/init?rand='+parseInt(Math.random()*100), { } , function(d){
      if(d.err == '0') {
        $('#add_weibo_num').empty().html('待发微博('+d.count+')');
        $('#add_weibo_today_num').empty().html('今天('+d.today+')');
        $('#add_weibo_tom_num').empty().html('明天('+d.tom+')');
        $('#add_weibo_all_num').empty().html('全部('+d.count+')');
        if ( d.show == 1 || mio.is_admin == 0 ) {
          add_weibo_toggle();
          if( d.list_show != '1' ) {
            add_weibo_list_hide_fast();
          }
        }
        add_weibo_init = 0;
      } else {
        if( d.list_show == '1' ) {
          committed_show();
        }
        add_weibo_init = 0;
        return false;
      }
    }, 'json');
    {else}
      $.post('{$smarty.const.SITE_URL}/timer/ajax/init?rand='+parseInt(Math.random()*100), { } , function(da){
          if(da.err == '0') {
            $('#add_weibo_num').empty().html('待发微博('+da.count+')');
            $('#add_weibo_today_num').empty().html('今天('+da.today+')');
            $('#add_weibo_tom_num').empty().html('明天('+da.tom+')');
            $('#add_weibo_all_num').empty().html('全部('+da.count+')');
          }
      }, 'json');
      add_weibo_toggle();
    {/if}
    $(".add_weibo_list_text_r").emotionsToHtml();
    add_weibo_flush_count();
  })

  //放新浪微博表情
  $("#add_face_icon").jqfaceedit( { txtAreaObj:$("#add_weibo_text"),containerObj:$('#box_con_face_con'),top:0,left:0, mio_name:'add_weibo_text' } );
  $("#edit_face").jqfaceedit( { txtAreaObj:$("#add_weibo_edit_text"),containerObj:$('#box_con_face_con'),top:0,left:0, mio_name:'add_weibo_edit_text' } );
</script>
<!-- 定时微博 JS END -->
{if user_helper::is_admin()}
  <div id="nav" class="nav">
    <a href="{AnUrl('app/admin')}" id="nav0" class="{if $module == 'app' && $action == 'index'}active{else}normal{/if}">应用管理</a>
    <a href='{if $app_id}{AnUrl("analysis/admin?app_id={$app_id}")}{else}{AnUrl("analysis/admin")}{/if}' id="nav1" class="{if $module == 'analysis'}active{else}normal{/if}">应用分析</a>
    <a href='{if $app_id}{AnUrl("user/admin?app_id={$app_id}")}{else}{AnUrl("user/admin")}{/if}' id="nav2" class="{if $mod == 'shuju' || $module == 'log'}active{else}normal{/if}">数据管理</a>
  {if user_helper::is_super_admin()}<!--<a href="{AnUrl('app/admin/add')}" id="nav3" class="{if $module == 'app' && $action == 'add'}active{else}normal{/if}">应用创建</a>
    <a href="{AnUrl('user/admin/member')}" id="nav4" class="{if $mod == 'member'}active{else}normal{/if}">管理员管理</a>  --> {/if}
    <a href="{AnUrl('opponent_analysis/sync_tag')}" id="nav4" class="{if $module == 'opponent_analysis'}active{else}normal{/if}">粉丝监控</a>
   <a href="{AnUrl('user/admin/auth')}" id="nav4" class="{if $mod == 'auth'}active{else}normal{/if}">授权信息管理</a>
  {if user_helper::is_super_admin()}<a href="{AnUrl('user/admin/verified')}" id="nav4" class="{if $module == 'user' && $action == 'verified'}active{else}normal{/if}">蓝V用户管理</a>
  <a href="{AnUrl('timer/admin/verified')}" id="nav4" class="{if $module == 'timer' && $action == 'verified'}active{else}normal{/if}">定时微博管理</a>
  {/if}
 </div>
 {/if}