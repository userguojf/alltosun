<?php/**  * alltosun.com 数据中心helper文件 data_helper.php  * ============================================================================  * 版权所有 (C) 2009-2013 北京互动阳光科技有限公司，并保留所有权利。  * 网站地址: http://www.alltosun.com  * ----------------------------------------------------------------------------  * 许可声明：这是一个开源程序，未经许可不得将本软件的整体或任何部分用于商业用途及再发布。  * ============================================================================  * $Author: 王敬飞 (wangjf@alltosun.com) $  * $Date: 2017年2月20日 下午6:20:13 $  * $Id$  */class data_helper{    /**     * 取更新错误日志条数     */    public static function count_error($record_id){        return _model('data_error_log')->getTotal(array('record_id' => $record_id));    }    /**     * 获取不存在的区域     */    public static function get_exists_region($region)    {        //拼接 sql        $old_region = $region;        if ($region == 'area') {            $old_region = "county";        }        $sql = 'SELECT DISTINCT '.$old_region.'Id FROM old_business';        //取所有数据        $list = _model('old_business')->getAll($sql);        $exists_list = array();        foreach ($list as $v) {            if ($v[$old_region.'Id']) {                $info = _uri($region, array('wifi_res_id' => $v[$old_region.'Id']));                if (!$info) {                    $exists_list[][$region.'_id'] = $v[$old_region.'Id'];                }            }        }        return $exists_list;    }    /**     * 检测member数据     */    public static function check_member()    {        global $mc_wr;        $check_member = $mc_wr->get('data_check_member');        $excep_data   = array();        if (!$check_member){            $count  = _model('business_hall')->getTotal(array(1=>1));            $page   = 1;            $check_member = array(                    'page'  => 1,                    'count' => $count,                    'data'  => array()            );        }        //页码        $max_num = data_config::$check_member_count;        $pager = ($check_member['page']-1)*$max_num;        //查询营业厅        $hall_list = _model('business_hall')->getList(array('1' => 1), ' LIMIT '.$pager.','.$max_num);        //完毕        if (!$hall_list) {            //删除缓存            $mc_wr->delete('data_check_member');            return array('info' => 'end', 'count' =>  $check_member['count']);        }        foreach($hall_list as $k => $v){            $info = _model('member')->read(array('member_user' => $v['user_number']));            if (empty($info)) {                //错误号， 1-member不存在                $v['errno'] = 1;                $check_member['data'][] = $v;                $excep_data[] = $v;            } else {                $num = _model('member')->getTotal(array('member_user' => $v['user_number']));                if ($num > 1) {                    //错误号， 1-member不存在                    $v['errno'] = 2;                    $check_member['data'][] = $v;                    $excep_data[] = $v;                }            }        }        $check_member['page'] += 1;        $mc_wr->set('data_check_member', $check_member, data_config::$check_member_cache_time);        return array('info' =>'ok', 'page' => $check_member['page'], 'count' => $check_member['count'], 'data' => $excep_data);    }    /**     * 检测省市区信息     */    public static function exception_region()    {        global $mc_wr;        $exception_region = $mc_wr->get('data_exception_region');        $excep_data   = array();        if (!$exception_region){            $count  = _model('business_hall')->getTotal(array(1=>1));            $page   = 1;            $exception_region = array(                    'page'  => 1,                    'count' => $count,                    'data'  => array()            );        }        //页码        $max_num = data_config::$exception_region_count;        $pager = ($exception_region['page']-1)*$max_num;        //查询营业厅        $hall_list = _model('business_hall')->getList(array('1' => 1), ' LIMIT '.$pager.','.$max_num);        //完毕        if (!$hall_list) {            //删除缓存            $mc_wr->delete('data_exception_region');            return array('info' => 'end', 'count' =>  $exception_region['count']);        }        foreach($hall_list as $k => $v) {            if (!$v['area_id']) {                continue;            }            //查询源数据表信息            $area_res_id = _uri('old_business', array('customerId' => $v['wifi_res_id']), 'countyId');            //根据旧表countyId查询区域表信息            $area_info = _uri('area', array('wifi_res_id' => $area_res_id));            if (!$area_info) {                //错误号， 101-本地不存在的区县信息                $v['errno'] = 101;                $exception_region['data'][] = $v;                $excep_data[] = $v;            } else if ($area_info['province_id'] != $v['province_id']) {                if (!$v['province_id']) {                    continue;                }                $v['errno'] = 104;                $exception_region['data'][] = $v;                $excep_data[] = $v;            } else if ($area_info['city_id'] != $v['city_id']){                if (!$v['city_id']) {                    continue;                }                $v['errno'] = 103;                $exception_region['data'][] = $v;                $excep_data[] = $v;            } else if ($area_info['id'] != $v['area_id']) {                if (!$v['area_id']) {                    continue;                }                $v['errno'] = 102;                $exception_region['data'][] = $v;                $excep_data[] = $v;            }        }        $exception_region['page'] += 1;        $mc_wr->set('data_exception_region', $exception_region, data_config::$exception_region_cache_time);        return array('info' =>'ok', 'page' => $exception_region['page'], 'count' => $exception_region['count'], 'data' => $excep_data);    }}