<?php/**  * alltosun.com 数据widget data.php  * ============================================================================  * 版权所有 (C) 2009-2013 北京互动阳光科技有限公司，并保留所有权利。  * 网站地址: http://www.alltosun.com  * ----------------------------------------------------------------------------  * 许可声明：这是一个开源程序，未经许可不得将本软件的整体或任何部分用于商业用途及再发布。  * ============================================================================  * $Author: 王敬飞 (wangjf@alltosun.com) $  * $Date: 2017年2月20日 下午12:05:12 $  * $Id$  */class data_widget{    public $app_id = 'wifi_mac_awzdxhyakax9b1rw';    public $app_key = 'qra4s9w2badfde0f3665dsf28322b4b2';    /**     * 更新awifi平台的营业厅数据     */    public function update_business_hall_by_awifi()    {        //线下平台通用一个库，所以专门一个bak库做测试        if (ONDEV) {            $table = 'business_hall_bak';        } else {            $table = 'business_hall';        }        //查询任务进度        $record_info = _model('data_update_record')->read(array('type' => 11));        if (!$record_info) {            //查询最后一次更新的版本号            $b_info = _model($table)->read(array(1=>1), ' ORDER BY `version` DESC ');            if ( !$b_info ) {                $last_version = 0;            } else {                $last_version = $b_info['version'];            }            $page         = 1;        } else {            $last_version = $record_info['version'];            $page         = $record_info['page'];        }        $params = array(                'version'       => $last_version,                'page'          => $page
        );        $time = time();        $token = api_helper::get_token($this->app_id, $this->app_key, $time);        if (ONDEV) {            $url = 'http://201512awifi.alltosun.net/api/mac/get_business_hall/get_business_hall_by_version?token='.$token.'&appid='.$this->app_id.'&timestamp='.$time;        } else {            $url = 'http://wifi.pzclub.cn/mac/get_business_hall/get_business_hall_by_version?token='.$token.'&appid='.$this->app_id.'&timestamp='.$time;        }        $result = curl_post($url, json_encode($params));        $arr = json_decode($result, true);        //请求失败        if (!$arr || !isset($arr['errcode'])) {            return json_encode(array(1, 'request fail', array()));        }        //更新完毕        if (count($arr['data']['data']) < 1) {            //更新完毕则查询更新进度            $b_info = _model($table)->read(array(1=>1), ' ORDER BY `version` DESC ');            if ( !$b_info ) {                $last_version = 1;            } else {                $last_version = date('YmdHis', strtotime($b_info['version']));            }            $page         = 1;            _model('data_update_record')->update(array('type' => 11), array('page' => $page, 'version' => $last_version));            return json_encode(array(0, 'success', array()));        }        $list_data = $arr['data']['data'];        foreach ($list_data as $k => $v) {            $new_member_info = $v['member'];            $new_group_user = $v['group_user'];            if (!$new_member_info || !$new_group_user) {                continue;            }            unset($v['member']);            unset($v['group_user']);            //查询id            $business_hall = _model($table)->read($v['id']);            //添加            if (!$business_hall) {                try{                    //更新                    $business_hall_id   = _model($table)->create($v);                    //线下mac平台和Awifi平台通用一个库，所以无需更新member相关                    if (!ONDEV) {                        $member_id          = _model('member')->create($new_member_info);                        $group_user_id      = _model('group_user')->create($new_group_user);                    }                }catch(Exception $e){                }            //更新            } else {                $res = _model($table)->update($v['id'], $v);            }        }        if ($arr['data']['page_count'] <= $page) {            //更新完毕则更新进度版本            $b_info = _model($table)->read(array(1=>1), ' ORDER BY `version` DESC ');            if ( !$b_info ) {                $last_version = 0;            } else {                $last_version = date('YmdHis', strtotime($b_info['version']));            }            $page         = 1;        } else {            $page++;        }        //更新进度        if (!$record_info) {            _model('data_update_record')->create(array('page' => $page, 'version' => $last_version, 'type' => 11));        } else {            _model('data_update_record')->update(array('type' => 11), array('page' => $page, 'version' => $last_version));        }    }    /**     * 导入到mongodb     */    public function import_to_mongodb2($source_table, $page, $to_table, $url, $to_db='screen')    {        if (!$source_table || !$to_table || !$page || !$to_db || !$url) {            echo '参数不完整';            exit;        }        //查询表字段        $fields = _model($source_table, 'group_db')->getAll('show full columns from '.$source_table);        $new_fields = array();        //处理字段为 int string        foreach ($fields as $k => $v) {            if ($v['Field'] == 'id') {                continue;            }            if (strpos($v['Type'], 'int(') !== false) {                $new_fields[][$v['Field']] = 'int';            } else {                $new_fields[][$v['Field']] = 'string';            }        }        //分页查询        if (!$page) $page = 1;        $limit = 10000;        $skip = ($page-1)*$limit;        $list = _model($source_table, 'group_db')->getList(array(1=>1), " ORDER BY id ASC LIMIT {$skip},{$limit}");        if (!$list) {            echo '处理完毕';            exit();        }        //插入        foreach ($list as $k => $v) {            $new_data = array();            //循环字段            foreach ($new_fields as $v1) {                $field = key($v1);                if ($v1[$field] == 'string') {                    $new_data[$field] = (string)($v[$field]);                } else if ($v1[$field] == 'int') {                    $new_data[$field] = (int)($v[$field]);                } else {                    echo '非法类型';                    p($field);                    exit();                }            }            _mongo($to_db, $to_table)->insertOne($new_data);        }        ++$page;        $url = $url."?page={$page}";        echo '<script>window.location.href="'.$url.'"</script>';    }}?>