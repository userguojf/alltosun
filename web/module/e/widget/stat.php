<?php/**  * alltosun.com 移动端后台 stat.php  * ============================================================================  * 版权所有 (C) 2009-2013 北京互动阳光科技有限公司，并保留所有权利。  * 网站地址: http://www.alltosun.com  * ----------------------------------------------------------------------------  * 许可声明：这是一个开源程序，未经许可不得将本软件的整体或任何部分用于商业用途及再发布。  * ============================================================================  * $Author: 王敬飞 (wangjf@alltosun.com) $  * $Date: 2016-8-18 上午9:30:06 $  * $Id$  */class stat_widget{   /**    * 折线图表    * @param $params    * @return bool    * add wangjf    */    public function  get_echart_line($params)    {        if (!isset($params['member_info']) || !$params['member_info']) {            return false;        }        $member_info        = $params['member_info'];        $user_title         = 'UV';        $home_page_title    = 'PV';        if($member_info['res_name']=='group'){            $user_title ='全国'.$user_title;            $home_page_title ='全国'.$home_page_title;        }else if($member_info['res_name']=='province' || $member_info['res_name']=='city'){            $res_title=_uri($member_info['res_name'],$member_info['res_id'],'name');            $user_title      = $res_title.$user_title;            $home_page_title = $res_title.$home_page_title;        }elseif($member_info['businell_hall']) {            $res_title = _uri('business_hall',$member_info['res_id'],'title');            $user_title      = $res_title.$user_title;            $home_page_title = $res_title.$home_page_title;        }        $user_list   = public_helper::get_user_count_by_type(2,$member_info['res_name'],$member_info['res_id'],true);        $home_page_list = stat_helper::get_home_page_data($member_info);        $user_length = count($user_list);        $home_page_length = count($home_page_list);        $count = $home_page_length > $user_length ?$home_page_length:$user_length;        //组装数据        $u_list = $h_list = array();        for ($i = 0 ; $i < $count; $i ++) {            //时间点统计            if ($home_page_list[$i]['time']) {                $h_date = $home_page_list[$i]['time'];                $h_list[$h_date] = $home_page_list[$i]['num'];            }            if ($user_list[$i]['date']) {                $u_date = str_replace('-','',$user_list[$i]['date']);                $u_list[$u_date] = $user_list[$i]['click_num'];            }        }        //双方数据唯一处理        if (isset($params['from']) && $params['from'] == 'awifi_app') {            $max_date = e_config::$app_stat_max_date_by_line;        } else {            $max_date = e_config::$stat_max_date_by_line;        }        $u_result = $h_result = $d_result = array();        for ($i = 0 ; $i <= $max_date; $i++) {            //时间点统计            $date = date('Ymd',time()-($max_date-$i)*24*60*60);            $d_result[$i] = $date;            if (array_key_exists($date, $u_list)) {                $u_result[$i] = $u_list[$date];            } else {                $u_result[$i] = 0;            }            if (array_key_exists($date, $h_list)) {                $h_result[$i] = $h_list[$date];            } else {                $h_result[] = 0;            }            $json['date']          = join(',', $d_result);            $json['uv']            = join(',', $u_result);            $json['pv']            = join(',', $h_result);        }        $json['user_title']      = $user_title;        $json['home_page_title'] = $home_page_title;        //p($json);exit;        return $json;    }    /**     * 地图图表widget     */    public function get_echart_map($params)    {        if (!isset($params['member_info']) || !$params['member_info'] || $params['member_info']['res_name'] != 'group') {            return false;        }        $member_info        = $params['member_info'];        $province_info_list = _model('province')->getList(array(1=>1));        $province_list      = array();        $max_num            = 0;        foreach ($province_info_list as $k => $v) {            $province_list[$k]['name']     = $v['name'];            $province_list[$k]['value']    = public_helper::get_user_count_by_type(2,'province', $v['id']); //今日连网人数            //取最大数，地图图表max值            if ($max_num < $province_list[$k]['value']) {                $max_num = $province_list[$k]['value'];            }        }        foreach ($province_list as $key=>$value){            $name_arr[$key] = $value['name'];            $value_arr[$key] = $value['value'];        }        //排序        array_multisort($value_arr,SORT_NUMERIC,SORT_DESC,$name_arr,SORT_STRING,SORT_ASC,$province_list);        $map_info['province_info_list'] = array();        if (isset($params['province_list'])) {            $map_info['province_info_list'] = $params['province_list'];        }        $map_info['user_num']           = public_helper::get_user_count_by_type(2,$member_info['res_name'], $member_info['res_id']);        //p($map_info);        $map_info['max_num']            = $max_num;        $map_info['province_list']      = $province_list;        $map_info['json_province_list'] = json_encode($province_list);        return $map_info;    }    /**     * 饼状图表widget     *     */    public function get_echart_pie($params)    {        if (!isset($params['member_info']) || !$params['member_info']) {            return false;        }        $list = array();        $member_info                          = $params['member_info'];        $list['new_user']                     = public_helper::get_user_count_by_type(1,$member_info['res_name'], $member_info['res_id']);        $list['auth_user_count']              = public_helper::get_user_count_by_type(2, $member_info['res_name'], $member_info['res_id']); //今日连网人数        $list['auth_user_count_format']       = number_format($list['auth_user_count']);        return $list;    }}