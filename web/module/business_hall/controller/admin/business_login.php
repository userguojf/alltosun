<?php/**  * alltosun.com 营业厅登录监控控制器 business_login.php  * ============================================================================  * 版权所有 (C) 2009-2013 北京互动阳光科技有限公司，并保留所有权利。  * 网站地址: http://www.alltosun.com  * ----------------------------------------------------------------------------  * 许可声明：这是一个开源程序，未经许可不得将本软件的整体或任何部分用于商业用途及再发布。  * ============================================================================  * $Author: 王敬飞 (wangjf@alltosun.com) $  * $Date: 2017年1月6日 上午11:21:43 $  * $Id$  */class Action{    private $per_page = 30;    private $time     = '';    private $member_id  = 0;    private $member_res_name = '';    private $member_res_id   = 0;    private $ranks           = 0;    public function __construct()    {        $this->member_id   = member_helper::get_member_id();        $member_info = member_helper::get_member_info($this->member_id);        if ($member_info) {            $this->member_res_name = $member_info['res_name'];            $this->member_res_id   = $member_info['res_id'];            $this->ranks           = $member_info['ranks'];            Response::assign('member_res_name', $this->member_res_name);            Response::assign('member_res_id', $this->member_res_id);        }        if ($this->member_res_name == 'area') {            return '您无权访问此页面';        }        Response::assign('curr_member_ranks', $this->ranks);    }    public function __call($action='', $params=array())    {        $page               = tools_helper::get('page_no', 1);        $search_filter      = Request::get('search_filter' ,array());        $three_date         = date('Y-m-d H:i:s', time() - 3600*24*3);        $list               = array();        //分权限获取城市初始条件        $filter = business_hall_helper::get_filter_by_member($this->member_res_name, $this->member_res_id);        //搜索判断        if (!empty($search_filter['province'])) {            $filter['province_id'] = $search_filter['province'];        }        if (!empty($search_filter['city'])) {            $filter['city_id'] = $search_filter['city'];        }        if (!empty($search_filter['area'])) {            $filter['area_id'] = $search_filter['area'];        }        if (!empty($search_filter['user_number'])) {            $filter['user_number'] = $search_filter['user_number'];        }        $filter['activity'] = 1;        $filter['type']     = array(4, 5);        //p($search_filter);        //p($filter);        //获取活跃营业厅id        $ids    = _model('business_hall')->getFields('id', $filter);        if (!$ids) {            $ids = 0;        }        //获取user_business_hll_num中活跃营业厅id        $hall_ids_active = _model('user_business_hall_num')->getFields('business_hall_id', array('business_hall_id' => $ids, 'last_login_time >' => $three_date), 'GROUP BY `business_hall_id`');        $hall_ids_all = _model('user_business_hall_num')->getFields('business_hall_id', array('business_hall_id' => $ids), 'GROUP BY `business_hall_id`');        if (!$hall_ids_all || !$hall_ids_active) {            $hall_ids = $hall_ids_all;        } else {            $hall_ids = array_diff($hall_ids_all, $hall_ids_active);        }        //计算数量        $count = count($hall_ids);        if ($count) {            $pager = new Pager($this->per_page);            $hall_ids = _model('user_business_hall_num')->getFields('business_hall_id',array('business_hall_id' => $hall_ids), ' GROUP BY `business_hall_id` '.$pager->getLimit($page));            if($pager->generate($count,$page)){                Response::assign('pager' , $pager);            }        }        //取每个厅的最后用户登录时间user_business_hall_num表        foreach ($hall_ids as $v) {            $filter = array(                'business_hall_id' => $v,            );            $info = _model('user_business_hall_num')->read($filter, 'ORDER BY `last_login_time` DESC');            if ($info) {                $business_info = _uri('business_hall', $info['business_hall_id']);                if (!$business_info) {                    continue;                }                $info['title']         = $business_info['title'];                $info['user_number']   = $business_info['user_number'];                $info['province']          = _uri('province', $business_info['province_id'], 'name');                $info['city']              = _uri('city', $business_info['city_id'], 'name');                $info['area']              = _uri('area', $business_info['area_id'], 'name');                //持续时间                $duration = time() - strtotime($info['last_login_time']);                $info['duration'] = floor($duration/(3600*24));                $list[] = $info;            }        }        if (!empty($search_filter['province'])) {            $province = array('province_id' => $search_filter['province']);            Response::assign('where1' , $province);        }        if (!empty($search_filter['city'])) {            $city = array('city_id' => $search_filter['city']);            Response::assign('where2' , $city);        }        //查询省厅地区信息        $region_info = business_hall_helper::get_region_by_member($this->member_res_name, $this->member_res_id);        Response::assign('search_filter', $search_filter);        Response::assign('region_info', $region_info);        Response::assign('count', $count);        Response::assign('business_list', $list);        Response::display('admin/business_login_list.html');    }    public function export() {        //缓存        global $mc_wr;        $export_data = $mc_wr->get('business_login_export_data');        if (!$export_data){          echo '<script>window.location.href=window.history.go(-1);</script>';exit();        }        if ($export_data['data']){            //删除缓存            $mc_wr->delete('business_login_export_data');            //执行完毕导出            $params['data'] = $export_data['data'];            $params['head'] = array('标题', '渠道编码', '省', '市', '区县', '持续时间', '最后活跃时间');            //导出            Csv::getCvsObj($params)->export();        }    }}