!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.MCanvas=e()}(this,function(){"use strict";function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!(this instanceof t))return new t(e);this.ops=i.extend({width:500,height:500,backgroundColor:""},e),this.canvas=null,this.ctx=null,this.queue=[],this.fn={success:function(){},error:function(){}},this.data={textId:0,text:{},bgConfig:null},this._init()}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i={extend:function(t,e){var i=this,o=this.isType(e);if("object"==o)this.forin(e,function(e,o){var n=i.isType(o);"object"!==n&&"array"!==n?t[e]=o:(i.isType(t[e])===n&&null!==t[e]||(t[e]="object"==n?{}:[]),i.extend(t[e],o))});else if("array"==o)for(var n=0;n<e.length;n++)t[n]=e[n];else t=e;return t},loadImage:function(t,e,i){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){e(o),setTimeout(function(){o=null},1e3)},o.onerror=function(){i("img load error")},o.src=t},isObject:function(t){return this.isObjFunc(t,"Object")},isBoolean:function(t){return this.isObjFunc(t,"Boolean")},isArr:function(t){return this.isObjFunc(t,"Array")},getImage:function(t,i,o){if("string"==typeof t)this.loadImage(t,function(t){i(t)},o);else{if("object"!=(void 0===t?"undefined":e(t)))return void console.log("add image error");i(t)}},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])},isIos8:function(){var t=window.navigator.userAgent.toLowerCase(),e=/(iPhone|iPad|iPod|iOS)/gi.test(t),i=/(iPad)/gi.test(t);return!!e&&(i?t.match(/cpu os (\d*)/)[1]<9:t.match(/iphone os (\d*)/)[1]<9)},deepCopy:function(t){return JSON.parse(JSON.stringify(t))},isObjFunc:function(t,e){return Object.prototype.toString.call(t)==="[object "+e+"]"},isType:function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","").toLowerCase()}},o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])}return t},n=function(){function t(t,e){var i=[],o=!0,n=!1,a=void 0;try{for(var r,s=t[Symbol.iterator]();!(o=(r=s.next()).done)&&(i.push(r.value),!e||i.length!==e);o=!0);}catch(t){n=!0,a=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw a}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();return t.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ctx.save(),this.ops.backgroundColor&&this.setBgColor(this.ops.backgroundColor)},t.prototype.background=function(t){var e=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{type:"origin"};return t||this.data.bgConfig?(t?(o.image=t,this.data.bgConfig=o):o=this.data.bgConfig,this.queue.push(function(){o.color&&e.setBgColor(o.color),i.getImage(o.image,function(t){e._background(t,o)},e.fn.error)}),this):void console.error("mcanvas error : the init background must has a image.")},t.prototype.setBgColor=function(t){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype._getBgAlign=function(t,e,i,o){var n=void 0;return"string"==typeof t?"50%"==t||"center"==t?n=Math.abs((e-i/o)/2):"100%"==t?n=Math.abs(e-i/o):"0%"==t&&(n=0):n="number"==typeof t?t:0,n},t.prototype._background=function(t,e){var i=this._getSize(t),o=i.iw,n=i.ih,a=o/n,r=this.canvas.width/this.canvas.height,s=void 0,h=void 0,c=void 0,d=void 0,l=void 0,p=void 0,f=void 0,u=void 0,g=void 0;switch(e.type){case"crop":a>r?(c=n*r,d=n,g=this.canvas.height/n):(c=o,d=c/r,g=this.canvas.width/o),s=this._getBgAlign(e.left,o,this.canvas.width,g),h=this._getBgAlign(e.top,n,this.canvas.height,g),p=l=0,u=this.canvas.height,f=this.canvas.width;break;case"contain":h=s=0,c=o,d=n,a>r?(f=this.canvas.width,u=f/a,l=e.left||0,p=e.top||0==e.top?e.top:(this.canvas.height-u)/2):(u=this.canvas.height,f=u*a,p=e.top||0,l=e.left||0==e.left?e.left:(this.canvas.width-f)/2);break;case"origin":this.canvas.width=o,this.canvas.height=n,s=h=0,c=o,d=n,l=p=0,f=this.canvas.width,u=this.canvas.height;break;default:return void console.error("mcanvas error:background type error!")}this.ctx.drawImage(t,s,h,c,d,l,p,f,u),this._next()},t.prototype.rect=function(t){var e=this;return this.queue.push(function(){var i=t.fillColor,o=void 0===i?"#fff":i,n=t.strokeColor,a=void 0===n?o:n,r=t.strokeWidth,s=void 0===r?0:r,h=e.canvas.width,c=e.canvas.height,d=e._get(h,0,t.width||0,"pos")-2*s,l=e._get(c,0,t.height||0,"pos")-2*s,p=e._get(h,d,t.x||0,"pos")+s/2,f=e._get(c,l,t.y||0,"pos")+s/2;e.ctx.lineWidth=s,e.ctx.fillStyle=o,e.ctx.strokeStyle=a,e.ctx.beginPath(),e.ctx.strokeRect(p,f,d,l),e.ctx.fillRect(p,f,d,l),e.ctx.closePath(),e._resetCtx()._next()}),this},t.prototype.circle=function(t){var e=this;return this.queue.push(function(){var i=t.fillColor,o=void 0===i?"#fff":i,n=t.strokeColor,a=void 0===n?o:n,r=t.strokeWidth,s=void 0===r?0:r,h=e.canvas.width,c=e.canvas.height,d=e._get(h,0,t.r||0,"pos")-2*s,l=e._get(h,2*d,t.x||0,"pos")+s/2+d,p=e._get(c,2*d,t.y||0,"pos")+s/2+d;e.ctx.beginPath(),e.ctx.arc(l,p,d,0,2*Math.PI,!1),e.ctx.fillStyle=o,e.ctx.fill(),e.ctx.strokeStyle=a,e.ctx.lineWidth=s,e.ctx.stroke(),e.ctx.closePath(),e._resetCtx()._next()}),this},t.prototype._resetCtx=function(){return this.ctx.setTransform(1,0,0,1,0,0),this.ctx.restore(),this},t.prototype.watermark=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments[1];if(!t)return void console.error("mcanvas error : there is not image of watermark.");var i=e.width,o=void 0===i?"40%":i,n=e.pos,a=void 0===n?"rightbottom":n,r=e.margin,s=void 0===r?20:r,h={x:0,y:0,scale:1,rotate:0};switch(a){case"leftTop":h.x="left:"+s,h.y="top:"+s;break;case"leftBottom":h.x="left:"+s,h.y="bottom:"+s;break;case"rightTop":h.x="right:"+s,h.y="top:"+s;break;case"rightBottom":h.x="right:"+s,h.y="bottom:"+s}return this.add(t,{width:o,pos:h}),this},t.prototype.add=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return i.isArr(e)||(e=[{image:e,options:o}]),e.forEach(function(e){t.queue.push(function(){i.getImage(e.image,function(o){t._add(o,t._handleOps(i.extend(n,e.options),o))},t.fn.error)})}),this},t.prototype._add=function(t,e){0==e.width&&console.warn("mcanvas warn: the width of mc-element is zero");var o=this._getSize(t),a=o.iw,r=o.ih,s=void 0,h=void 0,c=void 0,d=void 0,l=e.crop,p=l.x,f=l.y,u=l.width,g=l.height,v=u/g,x=void 0,y=void 0,w=void 0,m=void 0,b=document.createElement("canvas"),_=b.getContext("2d"),C=a>r?a/r:r/a,S=1.4*C>5?5:1.4*C,I=void 0,O=void 0;b.width=u*S,b.height=g*S;var k=void 0;if(i.isIos8()&&(b.width>2096||b.height>2096)?k=v>1?2096/b.width:2096/b.height:(b.width>4096||b.height>4096)&&(k=v>1?4096/b.width:4096/b.height),x=-Math.round(u/2),y=-Math.round(g/2),w=u,m=Math.round(u/v),k){var j=[b.width,b.height,x,y,w,m].map(function(t){return Math.round(t*k)}),T=n(j,6);b.width=T[0],b.height=T[1],x=T[2],y=T[3],w=T[4],m=T[5]}_.translate(b.width/2,b.height/2),_.rotate(e.pos.rotate),_.drawImage(t,p,f,u,g,x,y,w,m),c=e.width*S,d=c/v,I=(S-1)*e.width/2,O=I/v,s=e.pos.x+c*(1-e.pos.scale)/2-I,h=e.pos.y+d*(1-e.pos.scale)/2-O,c*=e.pos.scale,d*=e.pos.scale,this.ctx.drawImage(b,s,h,c,d),b=_=null,this._next()},t.prototype._getSize=function(t){var e=void 0,i=void 0;return"IMG"===t.tagName?(e=t.naturalWidth,i=t.naturalHeight):"CANVAS"===t.tagName?(e=t.width,i=t.height):(e=t.offsetWidth,i=t.offsetHeight),{iw:e,ih:i}},t.prototype._handleOps=function(t,e){var i=this.canvas.width,o=this.canvas.height,n=this._getSize(e),a=n.iw,r=n.ih,s=a/r,h=this._get(i,a,t.width,"pos"),c=void 0,d=void 0,l=t.crop,p=l.x,f=l.y,u=l.width,g=l.height,v={};v.width=this._get(i,a,u,"crop"),v.height=this._get(o,r,g,"crop"),v.x=this._get(a,v.width,p,"crop"),v.y=this._get(r,v.height,f,"crop"),v.x>a&&(v.x=a),v.y>r&&(v.y=r),c=a-v.x,d=r-v.y,v.width>c&&(v.width=c),v.height>d&&(v.height=d);var x=t.pos,y=x.x,w=x.y,m=x.rotate,b=x.scale;return{width:h,crop:v,pos:{x:this._get(i,h,y,"pos"),y:this._get(o,h/s,w,"pos"),scale:b,rotate:parseFloat(m)*Math.PI/180}}},t.prototype.text=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments[1],a="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",r=this.canvas.width/20;return this.queue.push(function(){var s={color:"#000",type:"fill",lineWidth:1,shadow:{color:null,blur:0,offsetX:0,offsetY:0}},h={width:300,align:"left",smallStyle:o({font:.8*r+"px "+a,lineHeight:.9*r},i.deepCopy(s)),normalStyle:o({font:r+"px "+a,lineHeight:1.1*r,type:"fill"},i.deepCopy(s)),largeStyle:o({font:1.3*r+"px "+a,lineHeight:1.4*r},i.deepCopy(s)),pos:{x:0,y:0,rotate:0}};h=i.extend(h,n);var c=t._parse(e),d=0,l=void 0;c.map(function(t){t.size>d&&(d=t.size,l=t.type)});var p=parseInt(h[l+"Style"].font);p&&h.width<p&&(h.width=p),t._text(c,h),t._resetCtx()._next()}),this},t.prototype._parse=function(t){for(var e=t.split(/<s>|<b>/),i=[],o=0;o<e.length;o++){var n=e[o];if(/<\/s>|<\/b>/.test(n)){var a=/<\/s>/.test(n)?"</s>":"</b>",r=/<\/s>/.test(n)?"small":"large",s=e[o].split(a);i.push({type:r,text:s[0],size:"small"==r?0:2}),s[1]&&i.push({type:"normal",text:s[1],size:1})}else e[o]&&i.push({text:e[o],type:"normal",size:1})}return i},t.prototype._text=function(t,e){var o=this;this.data.textId++,this.data.text[this.data.textId]={},e.width=this._get(this.canvas.width,0,e.width,"pos");var n=void 0,a=1,r=0,s=function(t,e){var i=0,o=void 0;return t.forEach(function(t){(o=e[t.type+"Style"].lineHeight)>i&&(i=o)}),i}(t,e),h=this._get(this.canvas.width,e.width,0,"pos"),c=this._get(this.canvas.height,0,0,"pos")+s;this.data.text[this.data.textId][a]={data:[],lineWidth:0},t.forEach(function(t){n=e[t.type+"Style"],o.ctx.font=n.font;var i=o.ctx.measureText(t.text).width,d=t.text.replace(/<br>/g,"|");if(r+i>e.width||-1!==d.indexOf("|"))for(var l=0,p=d.length;l<p;l++){var f=d[l];i=o.ctx.measureText(f).width,(r+i>e.width||"|"==f)&&(r=0,h=o._get(o.canvas.width,e.width,0,"pos"),c+=s,a+=1,o.data.text[o.data.textId][a]={data:[],lineWidth:0},"|"==f)||(o.data.text[o.data.textId][a].data.push({context:f,x:h,y:c,style:n,width:i}),r+=i,h+=i,o.data.text[o.data.textId][a].lineWidth=r)}else o.data.text[o.data.textId][a].data.push({context:d,x:h,y:c,style:n,width:i}),r+=i,h+=i,o.data.text[o.data.textId][a].lineWidth=r});var d=document.createElement("canvas"),l=d.getContext("2d"),p=this._get(this.canvas.width,e.width,e.pos.x,"pos"),f=this._get(this.canvas.height,0,e.pos.y,"pos"),u=void 0,g=void 0;u=d.width=e.width,g=d.height=this._getTextRectHeight(a),i.forin(this.data.text[this.data.textId],function(t,i){var n=0;i.lineWidth<e.width&&("center"==e.align?n=(e.width-i.lineWidth)/2:"right"==e.align&&(n=e.width-i.lineWidth)),i.data.forEach(function(t){t.x+=n,o._fillText(l,t)})});var v=p+u/2,x=f+g/2;this.ctx.translate(v,x),this.ctx.rotate(parseFloat(e.pos.rotate)*Math.PI/180),this.ctx.drawImage(d,-u/2,-g/2,u,g)},t.prototype._fillText=function(t,e){var o=e.context,n=e.x,a=e.y,r=e.style,s=r.align,h=r.lineWidth,c=r.shadow,d=c.color,l=c.blur,p=c.offsetX,f=c.offsetY;if(t.font=r.font,t.textAlign=s,t.textBaseline="alphabetic",t.lineWidth=h,t.shadowColor=d,t.shadowBlur=l,t.shadowOffsetX=p,t.shadowOffsetY=f,r.gradient){var u=r.gradient,g=u.type,v=u.colorStop,x=void 0,y=void 0,w=void 0,m=void 0;1==g?(x=n,y=a,w=n+e.width,m=a):(x=n,y=a-r.lineHeight,w=n,m=a);var b=t.createLinearGradient(x,y,w,m),_=v.length||0;i.forin(v,function(t,e){b.addColorStop(1/_*(+t+1),e)}),t[r.type+"Style"]=b}else t[r.type+"Style"]=r.color;t[r.type+"Text"](o,n,a),this._resetCtx()},t.prototype._getTextRectHeight=function(t){var e=this.data.text[this.data.textId][t].data[0];return e.y+e.style.lineHeight},t.prototype._get=function(t,e,i,o){var n=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"==o){var a=i.split(":");switch(a[0]){case"left":case"top":n=+a[1].replace("px","");break;case"right":case"bottom":n=t-+a[1].replace("px","")-e}}else n=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"==o?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"==i?(t-e)/2:"origin"==i?e:+i;return Math.round(n)},t.prototype.draw=function(t){var e=this,o={type:"jpg",quality:.9,success:function(){},error:function(){}},n=void 0;return"function"==typeof t?o.success=t:(o=i.extend(o,t),"jpg"==o.type&&(o.type="jpeg")),this.fn.error=o.error,this.fn.success=function(){setTimeout(function(){n=e.canvas.toDataURL("image/"+o.type,o.quality),o.success(n)},0)},this._next(),this},t.prototype._next=function(){this.queue.length>0?this.queue.shift()():this.fn.success()},t.prototype.clear=function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this},t});
//# sourceMappingURL=mcanvas.min.js.map
